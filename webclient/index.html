<!DOCTYPE html>
<html>
<head>

<link rel="icon" href="favicon.ico" type="image/x-icon" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
<link rel="stylesheet" type="text/css" href="style.css"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="manifest" href="/manifest.json">

<script
  src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
  crossorigin="anonymous"></script>

<script src="./reconnecting-websocket.min.js"></script>

<script type="text/javascript">
function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}
</script>

<script type="text/javascript">
var wsConn;
var reconnectInterval;
var playbackStateInterval;
var playlists;
var currentPlaylistId;
var playbackInfo;

function setupWebsocketConnection() {
    wsConn = new ReconnectingWebSocket('ws://'+window.location.hostname+':8080/action');
    wsConn.onopen = handleWsOpen;
    wsConn.onerror = handleWsError;
    wsConn.onclose = handleWsClose;
    wsConn.onmessage = handleWsMessage;
}

function handleWsOpen(e) {
    document.getElementById("connection_lost").style.display="none";

    clearInterval(reconnectInterval);
    //Load playlists
    wsConn.send('{ "cmd" : "get_playlists", "data" : {} }');
    //Get current volume
    wsConn.send('{ "cmd" : "get_volume", "data" : {} }');

    playbackStateInterval = window.setInterval(function() {
        wsConn.send('{ "cmd" : "get_playback_info", "data" : {} }');
    }, 1000);
}

function handleWsError(error) {
    console.log('WebSocket Error ' + error);
}

function handleWsClose(e) {
    window.clearInterval(playbackStateInterval);
    hideNowPlaying();
    document.getElementById("connection_lost").style.display="block";
}

function handlePlaybackInfo(jsonMsg) {
    var info = jsonMsg.data.playback_info;
    playbackInfo = info; //Update global playback info

    document.getElementById("now_playing_title").innerHTML = info.title;
    document.getElementById("now_playing_thumb").setAttribute("src", info.thumb_url);
    console.log("Duration: " + info.track_duration + ", played: " + info.track_playback_time);

    console.log(info.state);
    if(info.state === "playing" || info.state === "paused")
    {
        showNowPlaying();
        document.getElementById("btnStop").classList.remove("stateActive");
        if(info.state === "paused")
        {
            document.getElementById("btnPlay").classList.remove("stateActive");
            document.getElementById("btnPause").classList.add("stateActive");
        }
        else
        {
            document.getElementById("button_container").style.marginBottom = "60px";
            document.getElementById("btnPlay").classList.add("stateActive");
            document.getElementById("btnPause").classList.remove("stateActive");
        }
        
        var progressWidthPercent = (info.track_playback_time / info.track_duration) * 100;
        document.getElementById("progress_bar").style.width = progressWidthPercent+"%";
    }
    else
    {
        hideNowPlaying();
        document.getElementById("btnPause").classList.remove("stateActive");
        document.getElementById("btnStop").classList.add("stateActive");
        document.getElementById("btnPlay").classList.remove("stateActive");
        document.getElementById("progress_bar").style.width = "0";
    }
    if(info.playback_mode === "shuffle")
    {
        
    }
}

function handleWsMessage(e) {
    if(!e.data) { return; }
    var jsonMsg = JSON.parse(e.data);

    //Check for a valid message
    if(jsonMsg == null || !jsonMsg.data || (jsonMsg.error == undefined)) { return; }
    //Handle errors
    if(jsonMsg.error == 1)
    {
        if(jsonMsg.data.status === "playlist_fetch_failed")
        {
            var removeBlock = document.getElementById("playlist"+jsonMsg.data.playlist_id);
            blockContainer.removeChild(removeBlock);
            showNotification("Playlist download failed.");
        }
        return;
    }
    //Handle data
    if(jsonMsg.data.status === "playlists")
    {
        playlists = jsonMsg.data.playlists;
        showPlaylists();
    }
    if(jsonMsg.data.status === "playlist_add_in_progress")
    {
        var playlist = jsonMsg.data;
        blockContainer.appendChild(playlistToDom(playlist, true));
        return;
    }
    if(jsonMsg.data.status === "playlist_add_done")
    {
        var playlist = jsonMsg.data.playlist;
        var playlistDiv = document.getElementById("playlist"+playlist.id);
        //Check if "loading playlist block" is found
        if(playlistDiv)
        {
            var overlayToRemove = playlistDiv.getElementsByClassName("progress_overlay")[0];
            playlistDiv.removeChild(overlayToRemove);
        }
        else
        {
            //Not found, so create new one
            blockContainer.appendChild(playlistToDom(playlist, false));
        }

        return;
    }
    //Gets published when a playlist is being updated
    if(jsonMsg.data.status === "playlist_fetch_start")
    {
        var playlist_id = jsonMsg.data.playlist_id;
        var playlist_name = jsonMsg.data.playlist_name;
        var playlistDiv = document.getElementById("playlist"+playlist_id);
        //Check if playlist block is there
        if(playlistDiv)
        {
            //Show loading overlay
            var overlayToRemove = playlistDiv.getElementsByClassName("progress_overlay")[0];
            if(!overlayToRemove)
            {
                playlistDiv.prepend(createLoadingDom());
            }
        }
    }
    if(jsonMsg.data.status === "playlist_selected")
    {
        startPlaying();
        var listId = jsonMsg.data.playlist_id;
        try
        {
            document.getElementById("playlist"+currentPlaylistId).classList.remove("now_playing");
        } catch(e) {} //Catch, if nothing is selected
        currentPlaylistId = listId;
        document.getElementById("playlist"+listId).classList.add("now_playing");
        return;
    }
    if(jsonMsg.data.status === "playback_info")
    {
        handlePlaybackInfo(jsonMsg);
        return;
    }
    if(jsonMsg.data.status === "playback_started")
    {
        document.getElementById("button_container").style.marginBottom = "60px";
        document.getElementById("btnPause").classList.remove("stateActive");
        document.getElementById("btnStop").classList.remove("stateActive");
        document.getElementById("btnPlay").classList.add("stateActive");
    }
    if(jsonMsg.data.status === "playback_stopped")
    {
        try
        {
            document.getElementById("button_container").style.marginBottom = "0px";
            document.getElementById("btnPause").classList.remove("stateActive");
            document.getElementById("btnStop").classList.add("stateActive");
            document.getElementById("btnPlay").classList.remove("stateActive");
            document.getElementById("playlist"+currentPlaylistId).classList.remove("now_playing");
            return
        }
        catch(e) {}
        return;
    }
    if(jsonMsg.data.status === "playback_paused")
    {
        document.getElementById("btnPause").classList.add("stateActive");
        document.getElementById("btnStop").classList.remove("stateActive");
        document.getElementById("btnPlay").classList.remove("stateActive");
    }
}

function showNotification(message) {
    //TODO
}

function initGui() {
    var playlistNameInput = document.getElementById("playlist_name");
    var playlistUrlInput = document.getElementById("playlist_url");

    var circleDiv = document.getElementById("circle");
    circleDiv.addEventListener("touchstart", function()
    {
        circleDiv.style.backgroundColor = "#CCA83B";
    });
    circleDiv.addEventListener("mousedown", function()
    {
        circleDiv.style.backgroundColor = "#CCA83B";
    });
    circleDiv.addEventListener("mouseup", function()
    {
        circleDiv.style.backgroundColor = "#FFB035";
    });
    circleDiv.addEventListener("click", function() {
        overlay.style.display="block";
    });

    var overlayClose = document.getElementById("overlay_close");
    var overlay = document.getElementById("overlay");
    function closeOverlay() {
        overlay.style.display = "none";
        playlistNameInput.value = "";
        playlistUrlInput.value = "";
    }
    overlayClose.addEventListener("click", closeOverlay);


    //Volume slider component
    var volSlider = document.getElementById("volume_slider");
    var volSliderFunction = function() {
        wsConn.send('{ "cmd" : "set_volume", "data" : {"volume":'+volSlider.value+'} }');
    }
    volSlider.addEventListener("touchend", volSliderFunction);
    volSlider.addEventListener("mouseup", volSliderFunction);

    //Overlay button component
    var newPlaySendBtn = document.getElementById("sendform_button");
    var newPlayForm = document.getElementById("newPlayForm");
    var sendPlaylistURL = function() {
        newPlaySendBtn.setAttribute("disabled", "disabled");
        var playlistUrl = playlistUrlInput.value.trim();
        var playlistName = playlistNameInput.value.trim();
        wsConn.send('{ "cmd" : "add_playlist", '
            + '"data" : {"playlist_url":"'+playlistUrl+'", "name":"'+playlistName+'"} }');
        closeOverlay();
        newPlaySendBtn.removeAttribute("disabled");
    }
    newPlayForm.addEventListener("submit", function(e) {
        sendPlaylistURL();
        e.preventDefault();
        return false;
    });
    newPlaySendBtn.removeAttribute("disabled");

    //Progress bar event handlers
    var progressContainer = document.getElementById("progress_container");
    progressContainer.addEventListener("click", handleProgressClick, true);
}

function showNowPlaying() {
    document.getElementById("playback_info").style.marginBottom="0px";
}
function hideNowPlaying() {
    document.getElementById("button_container").style.marginBottom = "0px";
    document.getElementById("playback_info").style.marginBottom="-60px";
}

window.onload = function() {
    setupWebsocketConnection();

    blockContainer = document.getElementById("block_container");
    initGui();
}

function createLoadingDom() {
    var progressDiv = document.createElement("div");
    progressDiv.setAttribute("class", "progress_overlay");
    var loaderDiv1 = document.createElement("div");
    loaderDiv1.classList.add("lds-css");
    loaderDiv1.classList.add("ng-scope");
    var loaderDiv2 = document.createElement("div");
    loaderDiv2.style.width = "60px";
    loaderDiv2.style.height = "60px";
    loaderDiv2.classList.add("lds-eclipse");
    loaderDiv2.appendChild(document.createElement("div"));
    loaderDiv1.appendChild(loaderDiv2);
    progressDiv.appendChild(loaderDiv1);
    return progressDiv;
}

function playlistToDom(playlist, in_progress) {
    var blockDiv = document.createElement("div");
    blockDiv.setAttribute("class", "playlist_block");
    if(playlist.playing)
    {
        currentPlaylistId = playlist.id;
        blockDiv.classList.add("now_playing");
    }
    blockDiv.setAttribute("id", "playlist"+playlist.id);
    blockDiv.style.backgroundColor = getRandomColor();

    if(in_progress) {
        var progressDiv = createLoadingDom();
        blockDiv.appendChild(progressDiv);
    }

    var subDiv = document.createElement("div");
    subDiv.setAttribute("class", "block_content");
    var link = document.createElement("a");
    link.setAttribute("class", "title");
    link.setAttribute("href", "#");
    link.addEventListener("click", function() {
        wsConn.send('{ "cmd" : "select_playlist", "data" : {"playlist_id" : "'+playlist.id+'" } }');
    });
    var span = document.createElement("span");
    span.innerHTML = playlist.name;
    link.appendChild(span);
    subDiv.appendChild(link);
    blockDiv.appendChild(subDiv);

    return blockDiv;
}

function showPlaylists() {
    blockContainer.innerHTML = "";
    for (var list_id in playlists)
    {
        blockContainer.appendChild(playlistToDom(playlists[list_id], false));
    }
}

function playList(list_id) {
    if(list_id.trim() === "") return;
    wsConn.send('{ "cmd" : "select_playlist", "data" : {"playlist_id" : "'+list_id+'" } }');
}

function startPlaying() {
    wsConn.send('{ "cmd" : "play", "data" : {}}');
    showNowPlaying();
}
function stopPlaying() {
    wsConn.send('{ "cmd" : "stop", "data" : {}}');
    hideNowPlaying();
}
function pausePlaying() {
    wsConn.send('{ "cmd" : "pause", "data" : {}}');
}

function nextTrack() {
    wsConn.send('{ "cmd" : "nextTrack", "data" : {}}');
}

function previousTrack() {
    wsConn.send('{ "cmd" : "previousTrack", "data" : {}}');
}

function setPlaybackMode(mode) {
    if(mode === "repeat") 
    {
        document.getElementById("btnRepeat").classList.remove("hidden");
        document.getElementById("btnShuffle").classList.add("visible");
    }
    if(mode === "shuffle") 
    {
        document.getElementById("btnRepeat").classList.add("hidden");
        document.getElementById("btnShuffle").classList.remove("visible");
    }
}

function handleProgressClick(e) {
    if(playbackInfo.track_duration == undefined || playbackInfo.track_duration == 0) { return; }

    var clickedElm = e.target || e.srcElement;
    var x_clicked = e.pageX - this.offsetLeft;
    var totalWidth = this.offsetWidth;
    var newTime = (playbackInfo.track_duration * (x_clicked / totalWidth)).toFixed(2);
    wsConn.send('{ "cmd" : "setPlaybackTime", "data" : {"time" : "' + newTime + '"} }');
}

</script>

</head>
<body>

<div id="topContent">
    <h1>WGay Music Player</h1>

    0% <input type="range" min="60" max="100" value="<?php echo read_volume(); ?>" class="slider" id="volume_slider"> 100%
</div>

<div id="block_container">
</div>
<div id="add_button">
    <div id="circle">
        <span>+</span>
    </div>
</div>


<div id="overlay">
    <div id="overlay_bar">
    </div>
    <div id="overlay_content">
        <p>Neue Playlist hinzuf&uuml;gen</p>
        <form name="newlist" id="newPlayForm" onsubmit="event.preventDefault();">
            <b>Name:</b> <input type="text" name="playlist_name" id="playlist_name"/><br/><br/>
            <b>Link:</b> <input type="text" name="playlist_url" id="playlist_url"/><br />
            <input type="submit" value="Hinzuf&uuml;gen" id="sendform_button" disabled="disabled"/>
        </form>
        <button id="overlay_close">Fertig</button>
    </div>

</div>

<div id="button_container">
    <i id="btnPrevious" onclick="previousTrack()" class="material-icons">skip_previous</i>
    <i id="btnPlay" onclick="startPlaying()" class="material-icons">play_circle_outline</i></a>&nbsp;
    <i id="btnStop" onclick="stopPlaying()" class="material-icons">stop</i></a>&nbsp;
    <i id="btnPause" onclick="pausePlaying()" class="material-icons">pause_circle_outline</i></a>
    <i id="btnNext" onclick="nextTrack()" class="material-icons">skip_next</i></a>
    <div id="playback_mode_area">
        <i id="btnRepeat" onclick="setPlaybackMode('repeat')" class="material-icons hidden">repeat</i>
        <i id="btnShuffle" onclick="setPlaybackMode('shuffle')"class="material-icons">shuffle</i>
    </div>
</div>

<div id="playback_info" style="margin-bottom: -60px;">
    <div id="progress_container">
        <div id="progress_bar"></div>
    </div>
    <img id="now_playing_thumb" />
    <div id="now_playing_title"></div>
</div>

<div id="connection_lost" style="display:none;">
    <div>Connection lost. Reconnecting...</div>
</div>


</body>
</html>
